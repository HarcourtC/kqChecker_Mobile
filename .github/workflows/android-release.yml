name: Build signed APK on tag

on:
  push:
    tags:
      - 'v*'     # 或你需要的 tag 规则，例如 v1.*, v*

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Grant execute for gradlew
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: "${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}"
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install Android SDK command-line tools and packages
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"
          mkdir -p "${ANDROID_SDK_ROOT}"
          cd "${ANDROID_SDK_ROOT}"
          curl -sSfLo commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools.zip -d cmdline-tools
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/ || true
          export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${PATH}"
          yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --licenses || true
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-36" "build-tools;33.0.2"
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties

      - name: "Debug: list sync sources and show gradle version"
        run: |
          echo "Listing sync sources in app/src/main/java..."
          ls -la app/src/main/java/org/example/kqchecker/sync || true
          echo "Gradle wrapper info:"
          ./gradlew --version || true
          echo "Android SDK location:"
          cat local.properties || true
          ls -la gradle/wrapper || true

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${KEYSTORE_BASE64:-}" ]; then
            echo "ERROR: KEYSTORE_BASE64 secret is empty"
            exit 1
          fi
          printf '%s' "$KEYSTORE_BASE64" | base64 --decode > release-keystore.jks
          chmod 600 release-keystore.jks
          echo "Created keystore at release-keystore.jks"

      - name: Create keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${KEYSTORE_PASSWORD:-}" ] || [ -z "${KEY_ALIAS:-}" ] || [ -z "${KEY_PASSWORD:-}" ]; then
            echo "ERROR: one of the keystore secrets is empty"
            exit 1
          fi
          printf 'storeFile=release-keystore.jks\nstorePassword=%s\nkeyAlias=%s\nkeyPassword=%s\n' "$KEYSTORE_PASSWORD" "$KEY_ALIAS" "$KEY_PASSWORD" > keystore.properties
          chmod 600 keystore.properties

      - name: Build Release APK
        run: |
          set -euo pipefail
          ./gradlew assembleRelease --no-daemon --stacktrace -Pandroid.injected.testOnly=false

      - name: Verify and Upload release APK
        run: |
          set -euo pipefail
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "ERROR: APK not found at $APK_PATH"
            ls -R app/build/outputs || true
            exit 1
          fi

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.ref_name }}.apk
          path: app/build/outputs/apk/release/app-release.apk

      - name: Clean up keystore
        run: |
          set -euo pipefail
          # try secure delete, fallback to remove
          if command -v shred >/dev/null 2>&1; then
            shred -u release-keystore.jks || true
            shred -u keystore.properties || true
          else
            # best-effort overwrite then remove
            if [ -f release-keystore.jks ]; then
              dd if=/dev/zero of=release-keystore.jks bs=1M count=1 2>/dev/null || true
            fi
            rm -f release-keystore.jks || true
            rm -f keystore.properties || true
          fi
          # Unset sensitive envs
          unset KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD || true