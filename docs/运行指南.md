# 安卓真机运行程序指南

## 步骤1：启用开发者选项和USB调试模式

1. **打开设备设置**
   - 在安卓设备上找到并点击「设置」图标

2. **进入关于手机/设备**
   - 滚动到设置底部，点击「关于手机」或「关于设备」

3. **启用开发者选项**
   - 找到「版本号」或「内部版本号」
   - 快速连续点击该选项7次（会显示剩余点击次数）
   - 点击完成后会提示「您现在是开发者了」

4. **启用USB调试**
   - 返回设置主界面，找到并点击「开发者选项」
   - 滑动开关开启开发者选项
   - 找到「USB调试」选项并开启
   - 首次连接USB时，设备会弹出授权提示，点击「确定」允许USB调试

## 步骤2：通过USB线缆将设备连接到电脑并安装驱动

1. **准备工作**
   - 使用设备原装或高质量USB数据线
   - 确保电脑已安装最新的Android Studio或必要的驱动

2. **连接设备**
   - 使用USB线缆将设备连接到电脑
   - 设备可能会提示选择USB连接模式，请选择「文件传输」或「MTP」模式

3. **安装驱动（如果需要）**
   - Windows系统：可能会自动安装驱动，或者通过设备厂商官网下载并安装相应驱动
   - 常见设备厂商驱动下载地址：
     - 三星：Samsung USB Driver
     - 华为：HiSuite
     - 小米：小米助手
     - OPPO：OPPO USB驱动
     - vivo：vivo开发者工具

4. **验证设备连接**
   - 打开命令提示符或PowerShell
   - 输入命令：`adb devices`
   - 如果设备已正确连接，将显示设备序列号

## 步骤3：使用Android Studio或命令行构建并安装APK到设备

### 使用Android Studio方法

1. **打开项目**
   - 启动Android Studio
   - 点击「Open an Existing Project」，选择项目文件夹

2. **构建项目**
   - 点击菜单栏的「Build」→「Make Project」
   - 等待构建完成，确保没有编译错误

3. **运行项目到设备**
   - 点击工具栏上的绿色运行按钮
   - 或使用快捷键「Shift+F10」
   - 在弹出的「Select Deployment Target」窗口中，选择已连接的设备
   - 点击「OK」开始安装并运行

### 使用命令行方法

1. **打开命令提示符或PowerShell**
   - 导航到项目根目录
   - 命令：`cd e:\Program\kaoqing\Origin_Mobile`

2. **构建APK**
   - 执行命令：`./gradlew assembleDebug`（Linux/Mac）或 `gradlew assembleDebug`（Windows）
   - 等待构建完成，APK文件将生成在 `app\build\outputs\apk\debug\` 目录下

3. **安装APK到设备**
   - 确保设备已连接且可见（可通过`adb devices`确认）
   - 执行安装命令：`adb install -r app\build\outputs\apk\debug\app-debug.apk`
   - 安装成功后会显示「Success」消息

## 步骤4：在设备上打开并运行应用程序

1. **应用图标**
   - 安装完成后，应用图标会出现在设备的应用列表中
   - 如果使用Android Studio运行，应用可能会自动启动

2. **手动打开应用**
   - 在设备主屏幕或应用抽屉中找到应用图标
   - 点击图标启动应用程序

3. **首次运行注意事项**
   - 应用可能会请求必要的权限，请根据提示授权
   - 首次启动可能会进行初始化设置

4. **检查应用是否正常启动**
   - 确认应用主界面正确显示
   - 没有出现崩溃或错误提示

## 步骤5：测试应用程序功能，特别是api1和api2相关的功能

1. **测试api1功能**
   - 找到并点击应用中触发api1请求的功能按钮
   - 观察应用是否能正常响应，没有崩溃或错误提示

2. **测试api2考情流水功能**
   - 在Android设备上启动应用程序
   - 登录后进入主界面
   - 点击"调试请求"按钮（Debug Request）
   - 确认有"Fetch api2 (Water List)"按钮可用
   - 点击该按钮发起api2考情流水请求
   - 观察请求状态和返回结果

3. **验证配置修改是否生效**
   - 确认应用正确读取了config.json中的新配置
   - 验证api1和api2的URL和参数构造是否符合预期
   - 确认api2正确使用了config.json中的termNo值

4. **查看应用日志**
   - 打开Android Studio的Logcat窗口
   - 或使用命令行：`adb logcat | grep -i "api1\\|api2\\|payload\\|config"`
   - 观察日志中是否包含api1和api2请求的payload信息和配置读取情况
   - 特别关注是否有正确读取`termNo=606`和`week=13`的日志记录

5. **验证payload构造**
   - 日志中应显示在请求内部动态构造的payload信息
   - 确认api1的payload中包含正确的`termNo`和`week`值
   - 确认api2的payload中的字段完整：
     - `calendarBh`使用了config.json中的termNo值
     - `startdate`和`enddate`正确设置为当天日期（YYYY-MM-DD格式）
     - `pageSize`和`current`参数设置正确

6. **检查错误处理**
   - 验证应用是否能正确处理可能的配置读取异常
   - 日志中应有适当的错误信息记录
   - 检查网络连接问题的处理机制

7. **功能完整性测试**
   - 确保api1和api2请求的结果与预期一致
   - 验证api2响应数据是否按预期格式返回
   - 测试各种边界情况，确保功能稳定

8. **竞赛数据功能测试**（2025-02 新增）
   - 在调试界面中查找竞赛数据相关的调试按钮
   - 点击"Fetch Competition Data"按钮获取竞赛数据
   - 验证数据是否正确显示，包括竞赛标题、日期、链接等
   - 检查缓存文件：`adb shell run-as org.xjtuai.kqchecker cat files/competition_data.json`
   - 验证第二次调用是否从缓存读取（无网络请求）
   - 点击"Force Refresh Competition"按钮测试强制刷新功能

   ## 附：常用复现与调试步骤（2025-12 更新）

   - 强制清除应用缓存文件（在需要让应用重新从网络拉取时使用）：
      ```powershell
      adb shell run-as org.example.kqchecker rm -f /data/data/org.example.kqchecker/files/weekly.json;
      adb shell run-as org.example.kqchecker rm -f /data/data/org.example.kqchecker/files/weekly_raw.json;
      adb shell run-as org.example.kqchecker rm -f /data/data/org.example.kqchecker/files/weekly_cleaned.json
      ```

   - 捕获调试日志（只保留相关 tag）：
      ```powershell
      adb logcat -v time WeeklyRepository:* WeeklyCleaner:* FetchWeeklyRaw:* MainActivity:* *:S > fetch_weekly_debug_log.txt
      ```

   - 查看/拉取缓存文件（可用 `run-as` 权限）：
      ```powershell
      adb shell run-as org.example.kqchecker ls -l /data/data/org.example.kqchecker/files
      adb shell run-as org.example.kqchecker cat /data/data/org.example.kqchecker/files/weekly_raw.json > weekly_raw.json
      adb pull /data/data/org.example.kqchecker/files/weekly_cleaned.json .
      ```

   - APP 内的工具页支持下列便捷操作：
      - `Fetch Weekly (API)`：优先调用 `WeeklyRepository.fetchWeeklyRawFromApi()` 并在 UI 与 Logcat 中打印 API 原始响应；发生异常时回退到常规 `refreshWeeklyData()`。此按钮适合用于立即查看后端原始响应。
      - `Print cleaned weekly` / `Print weekly.json`：在 UI 中显示预览并把完整 JSON 分块写入 Logcat，便于复制或上传。
      - `打印 API2 原始响应`：读取并打印 `api2_query_log.json`（若 worker 有记录），用于排查 API2 返回的流水数据。

   - 集成（Integration）流程说明：
      - 点击应用“集成”页的 `Run Integration` 按钮会触发一个端到端流程：确保 `weekly_cleaned.json` 存在 -> 否则尝试从 `weekly.json` -> 否则拉取 API 并生成 cleaned -> 最终调用 `WriteCalendar` 写入系统日历。
      - 如果缺少日历权限，应用会请求权限并在用户同意后继续未完成的集成流程。

   - 认证失败处理：当后端返回 401/400/403 等认证相关错误时，仓库/Worker 会清理本地 token（SharedPreferences）并发送需要登录的 UI 事件，提示用户重新登录。

   - 竞赛数据相关命令（2025-02 新增）：
      - 清除竞赛缓存文件：
        ```powershell
        adb shell run-as org.xjtuai.kqchecker rm -f /data/data/org.xjtuai.kqchecker/files/competition_data.json
        ```
      - 查看竞赛缓存数据：
        ```powershell
        adb shell run-as org.xjtuai.kqchecker cat /data/data/org.xjtuai.kqchecker/files/competition_data.json
        ```
      - 捕获竞赛功能的日志：
        ```powershell
        adb logcat -v time CompetitionRepository:* CompetitionApiInterceptor:* MainActivity:* *:S > competition_debug_log.txt
        ```
