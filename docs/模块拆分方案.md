# 模块拆分方案

## 1. 当前问题分析

目前代码存在以下问题：

1. **MainActivity.kt过于庞大**（超过800行），包含了所有API调用、数据处理、缓存逻辑和UI展示
2. **职责不分离**：网络请求、数据缓存、业务逻辑和UI交互混合在一起
3. **难以维护**：修改一处逻辑可能影响多处功能
4. **测试困难**：无法单独测试各个功能模块

## 2. 建议的模块结构

```
org.example.kqchecker/
├── auth/                    # 现有认证模块（保留并优化）
│   ├── TokenManager.kt
│   ├── TokenAuthenticator.kt
│   ├── TokenStore.kt
│   └── WebLoginActivity.kt
│
├── network/                 # 新增：网络请求模块
│   ├── ApiService.kt        # API接口定义
│   ├── ApiClient.kt         # OkHttpClient配置
│   ├── TokenInterceptor.kt  # 从MainActivity迁移并优化
│   ├── CompetitionApiInterceptor.kt  # 竞赛API拦截器（2025-02 新增）
│   ├── TokenResponse.kt     # API响应模型
│   ├── WeeklyResponse.kt    # Weekly数据模型
│   └── CompetitionResponse.kt  # 竞赛数据模型（2025-02 新增）
│
├── repository/              # 新增：数据仓库模块
│   ├── WeeklyRepository.kt  # Weekly数据的业务逻辑
│   ├── WaterListRepository.kt # 水单数据的业务逻辑
│   ├── CompetitionRepository.kt # 竞赛数据的业务逻辑（2025-02 新增）
│   └── CacheManager.kt      # 缓存管理工具
│
├── model/                   # 新增：数据模型
│   ├── WeeklyData.kt        # Weekly相关数据类
│   └── WaterListData.kt     # 水单相关数据类
│
├── util/                    # 现有工具模块（保留并扩展）
│   ├── CalendarHelper.kt    # 现有日历工具
│   ├── JsonUtils.kt         # JSON处理工具
│   └── DateUtils.kt         # 日期处理工具
│
└── ui/                      # 新增：UI模块
    ├── MainActivity.kt      # 简化的主界面
    └── components/          # 可复用组件
        └── EventLog.kt      # 事件日志组件
```

## 3. 模块职责定义

### 3.1 Network模块

**职责**：
- 处理所有网络请求（API1、API2）
- 管理OkHttpClient配置
- 实现认证拦截器
- 定义API接口和响应模型

**关键类**：
- `ApiService`：使用Retrofit定义API接口
- `ApiClient`：创建和配置OkHttpClient
- `TokenInterceptor`：处理请求认证

### 3.2 Repository模块

**职责**：
- 封装数据获取逻辑（网络+缓存）
- 处理缓存过期检查
- 执行数据转换和业务规则
- 提供统一的数据访问接口

**关键类**：
- `WeeklyRepository`：管理weekly.json数据
- `WaterListRepository`：管理水单数据
- `CompetitionRepository`：管理竞赛数据（2025-02 新增，使用独立 OkHttpClient）
- `CacheManager`：处理缓存读写和过期检查

### 3.3 Model模块

**职责**：
- 定义应用中使用的所有数据类
- 实现数据序列化/反序列化
- 提供数据验证

### 3.4 Util模块

**职责**：
- 提供通用工具函数
- 处理JSON转换、日期格式化等

### 3.5 UI模块

**职责**：
- 展示界面
- 处理用户交互
- 调用Repository获取数据
- 不包含业务逻辑

## 4. 代码迁移计划

### 4.1 第一阶段：创建基础结构

1. 创建所有必要的包和基础类
2. 实现网络层（Network模块）
3. 定义数据模型（Model模块）

### 4.2 第二阶段：实现Repository层

1. 从MainActivity提取缓存逻辑到CacheManager
2. 实现WeeklyRepository和WaterListRepository
3. 测试Repository功能

### 4.3 第三阶段：重构UI层

1. 简化MainActivity
2. 将API调用替换为Repository调用
3. 分离UI和业务逻辑

## 5. 好处

1. **可维护性**：每个模块职责清晰，易于理解和修改
2. **可测试性**：可以单独测试各个模块
3. **可扩展性**：新增功能只需添加新的模块，不影响现有代码
4. **代码复用**：通用功能可以在多个地方使用
5. **团队协作**：不同开发者可以同时开发不同模块