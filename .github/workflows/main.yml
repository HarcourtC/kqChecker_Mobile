- name: Create Release using GitHub Script
  uses: actions/github-script@v7
  with:
    script: |
      // 正确做法：所有外部输入都通过模板字符串“注入”
      const releaseNotes = `${{ github.event.inputs.release_notes }}`;
      const tagName = `${{ github.event.inputs.version_tag }}`; // 从这里获取
      // 标题：如果用户提供了就用手动的，否则用标签名
      const releaseTitle = `${{ github.event.inputs.release_title || github.event.inputs.version_tag }}`;

      console.log(`Creating release: ${tagName} with title: ${releaseTitle}`);

      // 1. 调用GitHub API创建Release
      const response = await github.rest.repos.createRelease({
        owner: context.repo.owner,
        repo: context.repo.repo,
        tag_name: tagName,
        name: releaseTitle,
        body: releaseNotes,
        draft: false,
        // 注意：这里的布尔值也需要从外部注入
        prerelease: ${{ github.event.inputs.is_prerelease || false }}
      });

      // 2. 上传所有APK/AAB文件作为资产
      const fs = require('fs').promises;
      const path = require('path');
      const artifactDir = './downloaded-artifact';

      // 递归查找所有安装包文件
      async function findFiles(dir, ext) {
        let results = [];
        const items = await fs.readdir(dir, { withFileTypes: true });
        for (const item of items) {
          const fullPath = path.join(dir, item.name);
          if (item.isDirectory()) {
            results = results.concat(await findFiles(fullPath, ext));
          } else if (item.name.endsWith(ext)) {
            results.push(fullPath);
          }
        }
        return results;
      }

      const apkFiles = await findFiles(artifactDir, '.apk');
      const aabFiles = await findFiles(artifactDir, '.aab');
      const allFiles = [...apkFiles, ...aabFiles];

      for (const filePath of allFiles) {
        const fileName = path.basename(filePath);
        console.log(`Uploading asset: ${fileName}`);
        await github.rest.repos.uploadReleaseAsset({
          owner: context.repo.owner,
          repo: context.repo.repo,
          release_id: response.data.id,
          name: fileName,
          data: await fs.readFile(filePath)
        });
      }

      // 3. 输出Release URL（在后续步骤中可用）
      core.setOutput('release_url', response.data.html_url);
      console.log(`Release created successfully: ${response.data.html_url}`);
