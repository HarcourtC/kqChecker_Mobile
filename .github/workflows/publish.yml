name: Publish Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes'
        required: true
        type: string
        default: 'New release'
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: false
      build_run_id:
        description: 'Build workflow run ID (optional - leave empty for latest)'
        required: false
        type: string
      tag_name:
        description: 'Tag name (optional - defaults to version)'
        required: false
        type: string

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine build workflow run ID
        id: get-run-id
        run: |
          if [ -n "${{ github.event.inputs.build_run_id }}" ]; then
            echo "Using specified run ID: ${{ github.event.inputs.build_run_id }}"
            echo "run_id=${{ github.event.inputs.build_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "Finding latest successful build run..."
            # Get the latest successful run of the build workflow
            runs=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?event=push&status=success")

            # Find build workflow run (assuming your build workflow is named "Build signed APK on tag")
            run_id=$(echo "$runs" | jq -r '.workflow_runs[] | select(.name == "Build signed APK on tag" or .path == ".github/workflows/android-release.yml") | .id' | head -1)

            if [ -z "$run_id" ]; then
              echo "Error: No successful build runs found!"
              exit 1
            fi

            echo "Found run ID: $run_id"
            echo "run_id=$run_id" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts from build workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          # If you know your build workflow name, specify it:
          workflow: android-release.yml
          run_id: ${{ steps.get-run-id.outputs.run_id }}
          name: app-release-v*  # 你的 artifact 名称
          path: ./artifacts

      - name: List downloaded files
        run: ls -la ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.release_notes }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            ./artifacts/*.apk
            ./artifacts/*.aab
            ./artifacts/*.txt
          generate_release_notes: false