name: "Create Release"
on:
  workflow_dispatch: # 关键：手动触发
    inputs:
      version_tag:
        description: '版本标签 (例如 v1.2.3)'
        required: true
        type: string
        default: 'v1.0.0'
      release_title:
        description: 'Release标题'
        required: true
        type: string
        default: 'Production Release'
      release_notes:
        description: 'Release说明 (支持Markdown)'
        required: false
        type: textarea
        default: |
          ### 新特性
          - 功能一
          - 功能二
          ### 修复
          - 问题修复
      is_prerelease:
        description: '标记为预发布版本？'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 下载由“构建工作流”产出的APK工件
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-*.apk
          path: ./downloaded-artifact/
          # 注意：这里默认下载最新一次构建的工件。你可以使用 `github-workflow` 查询API来精确选择，但大多场景下“最新”即可。

      # 2. 查看下载的文件，确认无误（调试用）
      - name: List Downloaded Files
        run: ls -R ./downloaded-artifact/

      - name: Create Release using GitHub Script
        uses: actions/github-script@v7
        id: create-release
        with:
          script: |
            // 1. 在这里，我们可以安全地访问原始的输入值
            const releaseNotes = `${{ github.event.inputs.release_notes }}`;
            const tagName = `${{ github.event.inputs.version_tag }}`;
            const releaseTitle = `${{ github.event.inputs.release_title || tagName }}`;

            // 2. 调用GitHub API创建Release
            const response = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseTitle,
              body: releaseNotes,
              draft: false,
              prerelease: ${{ github.event.inputs.is_prerelease || false }}
            });

            // 3. （可选）上传资产（如APK）
            const fs = require('fs').promises;
            const files = await fs.readdir('./downloaded-artifact', { recursive: true });
            for (const file of files.filter(f => f.endsWith('.apk') || f.endsWith('.aab'))) {
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: response.data.id,
                name: file.split('/').pop(), // 取文件名
                data: await fs.readFile(`./downloaded-artifact/${file}`)
              });
            }

            // 4. 输出Release的URL，方便后续步骤使用
            return response.data.html_url;
        env:
          # 自动使用默认的 GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
